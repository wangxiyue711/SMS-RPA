<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RPA- ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="styles/main_app.css" />
    <!-- Firebase v9 ç¨³å®šç‰ˆæœ¬ -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      // Firebase é…ç½®
      const firebaseConfig = {
        apiKey: "AIzaSyCYPji9NAg4T3z8JJERd_MniCbdteC9P2g",
        authDomain: "rpa-sms-reclab.firebaseapp.com",
        projectId: "rpa-sms-reclab",
        storageBucket: "rpa-sms-reclab.firebasestorage.app",
        messagingSenderId: "815415607045",
        appId: "1:815415607045:web:e432022c62fbcb6899c16c",
        measurementId: "G-53WG49PVJF",
      };

      // Firebase åˆå§‹åŒ–
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // å…¨å±€å¯ç”¨
      window.auth = auth;
      window.db = db;

      // ä¸ºmain_appæ·»åŠ å¿…è¦çš„APIå‡½æ•°
      window.FirebaseAPI = {
        async logoutUser() {
          try {
            await signOut(auth);
            return { success: true };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },

        // è·å–ç”¨æˆ·é…ç½®ï¼ˆåŸºäºUIDï¼‰
        async getUserConfig() {
          if (!window.currentUser) {
            throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
          }

          try {
            const userConfigDoc = await getDoc(
              doc(db, "user_configs", window.currentUser.uid)
            );
            if (userConfigDoc.exists()) {
              return userConfigDoc.data();
            } else {
              // å¦‚æœç”¨æˆ·é…ç½®ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
              const defaultConfig = {
                user_id: window.currentUser.uid,
                email: window.currentUser.email,
                email_config: {
                  address: "",
                  app_password: "",
                },
                sms_config: {
                  provider: "",
                  api_url: "",
                  api_id: "",
                  api_password: "",
                  sms_text_a: "",
                  sms_text_b: "",
                },
                created_at: new Date(),
                updated_at: new Date(),
              };

              await setDoc(
                doc(db, "user_configs", window.currentUser.uid),
                defaultConfig
              );
              console.log("âœ… ç”¨æˆ·é…ç½®æ–‡æ¡£åˆ›å»ºæˆåŠŸ:", window.currentUser.uid);
              return defaultConfig;
            }
          } catch (error) {
            throw new Error("è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
          }
        },

        // æ›´æ–°ç”¨æˆ·é‚®ç®±é…ç½®
        async updateEmailConfig(emailAddress, appPassword, sitePassword) {
          if (!window.currentUser) {
            throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
          }

          try {
            console.log("ğŸ” å¼€å§‹æ›´æ–°é‚®ç®±é…ç½®:", {
              uid: window.currentUser.uid,
              email: emailAddress,
            });

            const userConfigRef = doc(
              db,
              "user_configs",
              window.currentUser.uid
            );

            // å…ˆæ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨
            const docSnap = await getDoc(userConfigRef);

            if (docSnap.exists()) {
              // æ–‡æ¡£å­˜åœ¨ï¼Œä½¿ç”¨updateDocæ›´æ–°
              console.log("ğŸ“„ æ–‡æ¡£å­˜åœ¨ï¼Œä½¿ç”¨updateDocæ›´æ–°");
              await updateDoc(userConfigRef, {
                email_config: {
                  address: emailAddress,
                  app_password: appPassword,
                  site_password: sitePassword,
                },
                updated_at: new Date(),
              });
            } else {
              // æ–‡æ¡£ä¸å­˜åœ¨ï¼Œä½¿ç”¨setDocåˆ›å»º
              console.log("ğŸ“ æ–‡æ¡£ä¸å­˜åœ¨ï¼Œä½¿ç”¨setDocåˆ›å»º");
              await setDoc(userConfigRef, {
                user_id: window.currentUser.uid,
                email: window.currentUser.email,
                email_config: {
                  address: emailAddress,
                  app_password: appPassword,
                  site_password: sitePassword,
                },
                sms_config: {
                  provider: "",
                  api_url: "",
                  api_id: "",
                  api_password: "",
                  sms_text_a: "",
                  sms_text_b: "",
                },
                created_at: new Date(),
                updated_at: new Date(),
              });
            }

            console.log("âœ… é‚®ç®±é…ç½®ä¿å­˜æˆåŠŸ:", {
              uid: window.currentUser.uid,
              email: emailAddress,
            });

            return { success: true };
          } catch (error) {
            console.error("âŒ é‚®ç®±é…ç½®ä¿å­˜å¤±è´¥:", error);
            console.error("é”™è¯¯è¯¦ç»†ä¿¡æ¯:", error.code, error.message);
            return { success: false, error: error.message };
          }
        },

        // SMSæä¾›å•†è‡ªåŠ¨æ£€æµ‹
        detectProvider(apiUrl) {
          const url = (apiUrl || "").toLowerCase();
          if (url.includes("sms-console.jp")) {
            return "sms-console";
          } else if (url.includes("twilio.com")) {
            return "twilio";
          } else if (url.includes("vonage.com") || url.includes("nexmo.com")) {
            return "vonage";
          } else if (url.includes("messagebird.com")) {
            return "messagebird";
          } else if (url.includes("plivo.com")) {
            return "plivo";
          } else {
            return "custom"; // è‡ªå®šä¹‰æˆ–å…¶ä»–æä¾›å•†
          }
        },

        // æ›´æ–°ç”¨æˆ·SMSé…ç½®ï¼ˆ5ä¸ªå¿…å¡«å­—æ®µï¼‰
        async updateSmsConfig(apiUrl, apiId, apiPassword, smsTextA, smsTextB) {
          if (!window.currentUser) {
            throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
          }

          try {
            console.log("ğŸ” é–‹å§‹æ›´æ–°SMSè¨­å®š:", {
              uid: window.currentUser.uid,
              apiUrl: apiUrl,
              apiId: apiId,
            });

            const userConfigRef = doc(
              db,
              "user_configs",
              window.currentUser.uid
            );

            // å…ˆæ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨
            const docSnap = await getDoc(userConfigRef);

            const smsConfig = {
              api_url: apiUrl,
              api_id: apiId,
              api_password: apiPassword,
              sms_text_a: smsTextA,
              sms_text_b: smsTextB,
              use_delivery_report: false, // æ·»åŠ é€è¾¾æŠ¥å‘Šè®¾ç½®
              provider: this.detectProvider(apiUrl), // åœ¨å¯¹è±¡æ–¹æ³•å†…ä½¿ç”¨this
            };

            if (docSnap.exists()) {
              // æ–‡æ¡£å­˜åœ¨ï¼Œä½¿ç”¨updateDocæ›´æ–°
              console.log("ğŸ“„ æ–‡æ¡£å­˜åœ¨ï¼Œä½¿ç”¨updateDocæ›´æ–°SMSè¨­å®š");
              await updateDoc(userConfigRef, {
                sms_config: smsConfig,
                updated_at: new Date(),
              });
            } else {
              // æ–‡æ¡£ä¸å­˜åœ¨ï¼Œä½¿ç”¨setDocåˆ›å»º
              console.log("ğŸ“ æ–‡æ¡£ä¸å­˜åœ¨ï¼Œä½¿ç”¨setDocåˆ›å»ºSMSè¨­å®š");
              await setDoc(userConfigRef, {
                user_id: window.currentUser.uid,
                email: window.currentUser.email,
                email_config: {
                  address: "",
                  app_password: "",
                  site_password: "",
                },
                sms_config: smsConfig,
                created_at: new Date(),
                updated_at: new Date(),
              });
            }

            console.log("âœ… SMSè¨­å®šä¿å­˜æˆåŠŸ:", {
              uid: window.currentUser.uid,
              fields: Object.keys(smsConfig).length,
            });

            return { success: true };
          } catch (error) {
            console.error("âŒ SMSè¨­å®šä¿å­˜å¤±æ•—:", error);
            console.error("éŒ¯èª¤è©³ç´°:", error.code, error.message);
            return { success: false, error: error.message };
          }
        },

        async getRpaConfig() {
          try {
            const config = await this.getUserConfig();
            return {
              success: true,
              config: {
                email: config.email_config?.address,
                emailPassword: config.email_config?.app_password,
                sitePassword: config.email_config?.site_password,
                smsProvider: config.sms_config?.provider,
                smsApiUrl: config.sms_config?.api_url,
                smsApiId: config.sms_config?.api_id,
                smsApiPassword: config.sms_config?.api_password,
                smsTextA: config.sms_config?.sms_text_a,
                smsTextB: config.sms_config?.sms_text_b,
              },
            };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },
      };

      // è®¤è¯çŠ¶æ€æ£€æŸ¥å¹¶åŠ è½½ç”¨æˆ·æ•°æ®
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          console.log("âŒ ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ");
          window.location.href = "login.html";
        } else {
          console.log("âœ… ç”¨æˆ·å·²ç™»å½•:", user.email, "UID:", user.uid);
          console.log("ğŸ” ç”¨æˆ·è¯¦ç»†ä¿¡æ¯:", {
            email: user.email,
            uid: user.uid,
            emailVerified: user.emailVerified,
            displayName: user.displayName,
          });

          window.currentUser = user;

          // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
          const userEmailElement = document.getElementById("userEmail");

          if (userEmailElement) {
            userEmailElement.textContent = user.email;
            console.log("ğŸ“§ å·²æ›´æ–°ç”¨æˆ·é‚®ç®±æ˜¾ç¤º:", user.email);
          }

          // åŠ è½½ç”¨æˆ·é…ç½®åˆ°è¡¨å•
          try {
            await loadUserConfigToForms();
            console.log("âœ… ç”¨æˆ·é…ç½®åŠ è½½å®Œæˆ");
          } catch (error) {
            console.error("âš ï¸ åŠ è½½ç”¨æˆ·é…ç½®å¤±è´¥:", error);
          }
        }
      });

      // åŠ è½½ç”¨æˆ·é…ç½®åˆ°è¡¨å•
      async function loadUserConfigToForms() {
        try {
          console.log("ğŸ“¥ å¼€å§‹åŠ è½½ç”¨æˆ·é…ç½®åˆ°è¡¨å•...");
          const config = await window.FirebaseAPI.getUserConfig();

          console.log("ğŸ“Š è·å–åˆ°çš„ç”¨æˆ·é…ç½®:", config);

          // åŠ è½½é‚®ç®±è®¾ç½®åˆ°è¡¨å•
          if (config.email_config) {
            const emailInput = document.getElementById("emailAddress");
            const passwordInput = document.getElementById("emailAppPassword");
            const sitePasswordInput = document.getElementById("sitePassword");

            if (emailInput)
              emailInput.value = config.email_config.address || "";
            if (passwordInput)
              passwordInput.value = config.email_config.app_password || "";
            if (sitePasswordInput)
              sitePasswordInput.value = config.email_config.site_password || "";

            console.log("âœ… é‚®ç®±è®¾ç½®å·²åŠ è½½åˆ°è¡¨å•");
          }

          // åŠ è½½SMSè®¾ç½®åˆ°è¡¨å• (æ”¯æŒå¤šç§APIæä¾›å•†)
          if (config.sms_config) {
            const urlInput = document.getElementById("smsApiUrl");
            const idInput = document.getElementById("smsApiId");
            const passwordInput = document.getElementById("smsApiPassword");
            const textAInput = document.getElementById("smsTextA");
            const textBInput = document.getElementById("smsTextB");

            if (urlInput) urlInput.value = config.sms_config.api_url || "";
            if (idInput) idInput.value = config.sms_config.api_id || "";
            if (passwordInput)
              passwordInput.value = config.sms_config.api_password || "";
            if (textAInput)
              textAInput.value = config.sms_config.sms_text_a || "";
            if (textBInput)
              textBInput.value = config.sms_config.sms_text_b || "";

            console.log("âœ… SMSè¨­å®šå·²åŠ è¼‰åˆ°è¡¨å–® (5é …ç›®)");
          }
        } catch (error) {
          console.error("âš ï¸ åŠ è½½ç”¨æˆ·é…ç½®å¤±è´¥:", error);
        }
      }

      console.log("âœ… Main App Firebase initialized");
    </script>
  </head>
  <body>
    <div class="container">
      <!-- é¡¶éƒ¨Header -->
      <header class="header">
        <div class="brand">
          <span class="brand-title">ğŸ¤– XXX XXXX</span>
        </div>
        <div class="user-info">
          <span id="userEmail">èª­ã¿è¾¼ã¿ä¸­...</span>
          <button id="logoutBtn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </header>

      <!-- ä¸»ä½“éƒ¨åˆ† -->
      <div class="main-wrapper">
        <!-- å·¦ä¾§èœå•æ  -->
        <nav class="sidebar">
          <ul class="nav-menu">
            <li><a href="#" class="active" id="navMail">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</a></li>
            <li><a href="#" id="navApi">SMSè¨­å®š</a></li>
            <li><a href="#" id="navRpa">RPAå®Ÿè¡Œ</a></li>
            <li><a href="#" id="navSms">å€‹åˆ¥é€ä¿¡ãƒ†ã‚¹ãƒˆç”¨</a></li>
          </ul>
        </nav>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <section class="main-content">
          <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šãƒ‘ãƒãƒ« -->
          <div class="content-panel active" id="panelMail">
            <div class="panel-header">
              <h2 class="panel-title">ğŸ“§ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h2>
              <p class="panel-description">
                RPAè‡ªå‹•åŒ–ã«å¿…è¦ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆ3é …ç›®ã®ã¿ï¼‰
              </p>
            </div>

            <form class="ai-form" onsubmit="saveAccountConfig(event)">
              <label for="emailAddress">ğŸ“¬ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
              <input
                type="email"
                id="emailAddress"
                name="emailAddress"
                placeholder="example@gmail.com"
                required
                autocomplete="off"
              />
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                RPAãŒç›£è¦–ã™ã‚‹Gmailã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆIndeedæ±‚äººãƒ¡ãƒ¼ãƒ«å—ä¿¡ç”¨ï¼‰
              </div>

              <label for="emailAppPassword">ğŸ”‘ Gmailã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <input
                type="password"
                id="emailAppPassword"
                name="appPassword"
                placeholder="16æ–‡å­—ã®ã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                required
              />
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                Googleè¨­å®šâ†’ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£â†’2æ®µéšèªè¨¼â†’ã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ç”Ÿæˆ
              </div>

              <label for="sitePassword">ğŸŒ Indeedãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <input
                type="password"
                id="sitePassword"
                name="sitePassword"
                placeholder="Indeedã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                required
              />
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                Indeedæ±‚äººã‚µã‚¤ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
              </div>

              <button type="submit">ğŸ’¾ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã‚’ä¿å­˜</button>
            </form>

            <div
              id="accountStatus"
              class="ai-hint"
              style="margin-top: 16px; min-height: 20px"
            ></div>
          </div>

          <!-- SMSè¨­å®šãƒ‘ãƒãƒ« -->
          <div class="content-panel" id="panelApi">
            <div class="panel-header">
              <h2 class="panel-title">ğŸ“± SMSè¨­å®š</h2>
              <p class="panel-description">
                SMSé€ä¿¡APIè¨­å®šã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆ5é …ç›®å¿…é ˆï¼‰<br />
                <small
                  >å¯¾å¿œAPI: SMS Consoleã€Twilioã€ãã®ä»–HTTP APIæä¾›å•†</small
                >
              </p>
            </div>

            <form class="ai-form" onsubmit="saveSmsConfig(event)">
              <label for="smsApiUrl">ğŸŒ SMS API URL</label>
              <input
                type="url"
                id="smsApiUrl"
                name="smsApiUrl"
                placeholder="ä¾‹: https://www.sms-console.jp/api/ æˆ– https://api.twilio.com/2010-04-01/"
                required
                autocomplete="off"
              />
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                å„ç¤¾ã®SMS APIæä¾›å•†ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLï¼ˆSMS Consoleã€Twilioç­‰ï¼‰
              </div>

              <label for="smsApiId">ğŸ”‘ SMS API ID / ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
              <input
                type="text"
                id="smsApiId"
                name="smsApiId"
                placeholder="ä¾‹: sm000206_user (SMS Console) æˆ– AC1234567890abcdef (Twilio)"
                required
                autocomplete="off"
              />
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                SMS APIæä¾›å•†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã¾ãŸã¯Account SID
              </div>

              <label for="smsApiPassword"
                >ğŸ” SMS API ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ / ãƒˆãƒ¼ã‚¯ãƒ³</label
              >
              <input
                type="password"
                id="smsApiPassword"
                name="smsApiPassword"
                placeholder="APIå°‚ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ æˆ– Auth Token"
                required
              />
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                SMS APIèªè¨¼ç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒˆãƒ¼ã‚¯ãƒ³ã€ã¾ãŸã¯Auth Token
              </div>

              <label for="smsTextA">ğŸ“„ SMSãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆAï¼ˆ1å›ç›®é€ä¿¡ç”¨ï¼‰</label>
              <textarea
                id="smsTextA"
                name="smsTextA"
                placeholder="ã‚Šãã‚‰ã¼æ ªå¼ä¼šç¤¾ã§ã™&#10;ã”å¿œå‹Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™&#10;LINEã§é¸è€ƒæ¡ˆå†…â†’&#10;https://line.me/R/ti/p/@637nkhcm"
                required
                rows="4"
              ></textarea>
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                åˆå›ã¾ãŸã¯1åˆ†çµŒéå¾Œã®é€ä¿¡ã§ä½¿ç”¨ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
              </div>

              <label for="smsTextB">ğŸ“ SMSãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆBï¼ˆ2å›ç›®é€ä¿¡ç”¨ï¼‰</label>
              <textarea
                id="smsTextB"
                name="smsTextB"
                placeholder="ã‚Šãã‚‰ã¼æ ªå¼ä¼šç¤¾ã§ã™ã€‚&#10;ã”å¿œå‹Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼&#10;LINEã§é¸è€ƒæ¡ˆå†…â†’&#10;https://line.me/R/ti/p/@637nkhcm"
                required
                rows="4"
              ></textarea>
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                1åˆ†ä»¥å†…ã®é‡è¤‡é€ä¿¡ã§ä½¿ç”¨ã™ã‚‹ä»£æ›¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
              </div>

              <button type="submit">ğŸ’¾ SMSè¨­å®šã‚’ä¿å­˜</button>
            </form>

            <div
              id="smsStatus"
              class="ai-hint"
              style="margin-top: 16px; min-height: 20px"
            ></div>
          </div>

          <!-- SMSé€ä¿¡ãƒ‘ãƒãƒ« -->
          <div class="content-panel" id="panelSms">
            <div class="panel-header">
              <h2 class="panel-title">ğŸ“± SMSé€ä¿¡</h2>
              <p class="panel-description">
                å€‹åˆ¥ã«SMSã‚’é€ä¿¡ã§ãã¾ã™ã€‚æ‰‹å‹•ã§é›»è©±ç•ªå·ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚
              </p>
            </div>

            <!-- è¿æ¥çŠ¶æ€æ£€æŸ¥ -->
            <div
              id="connectionStatus"
              style="
                margin-bottom: 16px;
                padding: 8px;
                border-radius: 4px;
                font-size: 12px;
              "
            >
              <span id="statusText">ğŸ” ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...</span>
            </div>

            <form class="ai-form" onsubmit="sendIndividualSms(event)">
              <label for="recipientPhone">ğŸ“ é€ä¿¡å…ˆé›»è©±ç•ªå·</label>
              <input
                type="tel"
                id="recipientPhone"
                name="recipientPhone"
                placeholder="ä¾‹: +819012345678 ã¾ãŸã¯ 09012345678"
                required
                autocomplete="off"
                pattern="^(\+81|0)?[0-9]{10,11}$"
              />
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                æ—¥æœ¬ã®æºå¸¯é›»è©±ç•ªå·ï¼ˆ+81å½¢å¼ã¾ãŸã¯0ã‹ã‚‰å§‹ã¾ã‚‹å½¢å¼ï¼‰
              </div>

              <label for="smsContent">ğŸ’¬ é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
              <textarea
                id="smsContent"
                name="smsContent"
                placeholder="é€ä¿¡ã—ãŸã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#10;&#10;ä¾‹ï¼š&#10;ã“ã‚“ã«ã¡ã¯ï¼&#10;ãŠç–²ã‚Œæ§˜ã§ã™ã€‚"
                required
                rows="6"
                maxlength="670"
              ></textarea>
              <div
                class="ai-hint"
                style="margin-top: 4px; font-size: 12px; color: #666"
              >
                æœ€å¤§670æ–‡å­—ã¾ã§ã€‚æ—¥æœ¬èªã¯å…¨è§’æ–‡å­—ã§è¨ˆç®—ã•ã‚Œã¾ã™ã€‚
              </div>

              <div style="margin: 16px 0">
                <label>
                  <input
                    type="checkbox"
                    id="useTemplate"
                    onchange="toggleTemplate()"
                  />
                  æ—¢å­˜ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
                </label>
              </div>

              <div
                id="templateSelector"
                style="display: none; margin-bottom: 16px"
              >
                <button
                  type="button"
                  onclick="loadTemplate('A')"
                  style="
                    margin-right: 8px;
                    padding: 6px 12px;
                    background: #6f8333;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                  "
                >
                  ğŸ“„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆA
                </button>
                <button
                  type="button"
                  onclick="loadTemplate('B')"
                  style="
                    padding: 6px 12px;
                    background: #8fa446;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                  "
                >
                  ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆB
                </button>
              </div>

              <button
                type="submit"
                style="
                  background: linear-gradient(135deg, #6f8333 0%, #8fa446 100%);
                  color: white;
                  font-weight: bold;
                "
              >
                ğŸ“¤ SMSé€ä¿¡
              </button>
            </form>

            <div
              id="smsResult"
              class="ai-hint"
              style="margin-top: 16px; min-height: 20px"
            ></div>

            <!-- é€ä¿¡å±¥æ­´ -->
            <div style="margin-top: 32px">
              <h3 style="color: #6f8333; margin-bottom: 16px">ğŸ“‹ é€ä¿¡å±¥æ­´</h3>
              <div
                id="smsHistory"
                style="
                  max-height: 400px;
                  overflow-y: auto;
                  border: 1px solid #e8eae0;
                  border-radius: 12px;
                  padding: 16px;
                  background: #fafafa;
                  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
                "
              >
                <p
                  style="
                    color: #666;
                    text-align: center;
                    margin: 20px 0;
                    font-style: italic;
                  "
                >
                  é€ä¿¡å±¥æ­´ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                </p>
              </div>
              <button
                type="button"
                onclick="clearSmsHistory()"
                style="
                  margin-top: 8px;
                  margin-right: 8px;
                  padding: 4px 8px;
                  background: #dc3545;
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 12px;
                "
              >
                å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
              </button>
            </div>
          </div>

          <!-- RPAå®Ÿè¡Œãƒ‘ãƒãƒ« -->
          <div class="content-panel" id="panelRpa">
            <div class="panel-header">
              <h2 class="panel-title">RPAå®Ÿè¡Œ</h2>
            </div>

            <!-- ç°åœ¨çš„è®¾å®šçŠ¶å†µ -->
            <div class="config-status">
              <h3
                style="margin-bottom: 16px; color: #8c9569; font-size: 1.1rem"
              >
                ç¾åœ¨ã®è¨­å®šçŠ¶æ³
              </h3>
              <div id="configDisplay" class="config-display">
                <div class="config-item">
                  <span class="icon">ğŸ“§</span>
                  <span
                    >ãƒ¡ãƒ¼ãƒ«: <span id="emailStatus">èª­ã¿è¾¼ã¿ä¸­...</span></span
                  >
                  <span class="status-icon"></span>
                </div>
                <div class="config-item">
                  <span class="icon">ğŸ“±</span>
                  <span
                    >SMS API: <span id="smsApiStatus">èª­ã¿è¾¼ã¿ä¸­...</span></span
                  >
                  <span class="status-icon"></span>
                </div>
                <div class="config-item">
                  <span class="icon">ğŸ”‘</span>
                  <span
                    >API ID: <span id="apiIdStatus">èª­ã¿è¾¼ã¿ä¸­...</span></span
                  >
                  <span class="status-icon"></span>
                </div>
                <div class="config-item">
                  <span class="icon">ğŸ”</span>
                  <span
                    >API ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:
                    <span id="apiPasswordStatus">èª­ã¿è¾¼ã¿ä¸­...</span></span
                  >
                  <span class="status-icon"></span>
                </div>
                <div class="config-item">
                  <span class="icon">ğŸ“„</span>
                  <span
                    >ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆA:
                    <span id="templateAStatus">èª­ã¿è¾¼ã¿ä¸­...</span></span
                  >
                  <span class="status-icon"></span>
                </div>
                <div class="config-item">
                  <span class="icon">ğŸ“</span>
                  <span
                    >ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆB:
                    <span id="templateBStatus">èª­ã¿è¾¼ã¿ä¸­...</span></span
                  >
                  <span class="status-icon"></span>
                </div>
              </div>
            </div>

            <!-- RPAå®è¡ŒæŒ‰é’® -->
            <button
              class="btn btn-primary"
              onclick="executeRpa()"
              style="margin-top: 20px; padding: 12px 30px; font-size: 1.1rem"
            >
              ğŸš€ RPAå®Ÿè¡Œ
            </button>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div
              id="rpaResult"
              class="result-display"
              style="margin-top: 20px; display: none"
            ></div>

            <!-- æç¤ºä¿¡æ¯ -->
            <div class="ai-hint" style="margin-top: 24px">
              RPAå®Ÿè¡Œå‰ã«ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã¨SMS
              APIè¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      // API é…ç½®
      const API_BASE_URL = window.location.hostname === 'localhost' 
  ? "http://localhost:8888" 
  : `https://${window.location.hostname}`;

      // å·¦ä¾§èœå•åˆ‡æ¢é€»è¾‘
      document.addEventListener("DOMContentLoaded", function () {
        // å¯¹åº”çš„æŒ‰é’®ä¸é¢æ¿æ˜ å°„
        const navs = [
          { btn: "navMail", panel: "panelMail" },
          { btn: "navApi", panel: "panelApi" },
          { btn: "navRpa", panel: "panelRpa" },
          { btn: "navSms", panel: "panelSms" },
        ];

        function hideAll() {
          navs.forEach(({ btn, panel }) => {
            const b = document.getElementById(btn);
            const p = document.getElementById(panel);
            if (b) b.classList.remove("active");
            if (p) {
              p.classList.remove("active");
              p.style.display = "none";
            }
          });
        }

        navs.forEach(({ btn, panel }) => {
          const b = document.getElementById(btn);
          if (!b) return;
          b.addEventListener("click", function () {
            hideAll();
            b.classList.add("active");
            const p = document.getElementById(panel);
            if (p) {
              p.classList.add("active");
              p.style.display = "block";
            }

            // RPA ã‚¿ãƒ–ã®å ´åˆã€è¨­å®šã‚’èª­ã¿è¾¼ã¿
            if (panel === "panelRpa") {
              // é¦–å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
              initializeRpaStatus();
              // ç„¶ååŠ è½½å®é™…é…ç½®
              loadRpaConfig();
            }
          });
        });

        // åˆå§‹åŒ–ï¼šé»˜è®¤æ˜¾ç¤º mail é¢æ¿
        const first = navs[0];
        const b = document.getElementById(first.btn);
        const p = document.getElementById(first.panel);
        if (b) b.classList.add("active");
        if (p) {
          p.classList.add("active");
          p.style.display = "block";
        }
      });

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
      async function handleLogout() {
        if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
          await window.FirebaseAPI.logoutUser();
          window.location.href = "login.html";
        }
      }

      // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šä¿å­˜
      async function saveAccountConfig(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        console.log("ğŸ” é–‹å§‹ä¿å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š...");
        console.log("ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:", formData.get("emailAddress"));
        console.log("ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:", window.currentUser);

        if (!window.currentUser) {
          document.getElementById("accountStatus").innerHTML =
            '<span style="color: #d32f2f;">âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</span>';
          return;
        }

        try {
          document.getElementById("accountStatus").innerHTML =
            '<span style="color: #1976d2;">ğŸ’¾ è¨­å®šã‚’ä¿å­˜ä¸­...</span>';

          const result = await window.FirebaseAPI.updateEmailConfig(
            formData.get("emailAddress"),
            formData.get("appPassword"),
            formData.get("sitePassword")
          );

          console.log("ğŸ“Š ä¿å­˜çµæœ:", result);

          if (result.success) {
            document.getElementById("accountStatus").innerHTML =
              '<span style="color: #388e3c;">âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ</span>';
          } else {
            document.getElementById("accountStatus").innerHTML =
              '<span style="color: #d32f2f;">âŒ ã‚¨ãƒ©ãƒ¼: ' +
              result.error +
              "</span>";
            console.error("ä¿å­˜å¤±æ•—è©³ç´°:", result);
          }
        } catch (error) {
          console.error("ğŸ’¥ ä¿å­˜ç•°å¸¸:", error);
          document.getElementById("accountStatus").innerHTML =
            '<span style="color: #d32f2f;">âŒ ã‚¨ãƒ©ãƒ¼: ' +
            error.message +
            "</span>";
        }
      }

      // SMSè¨­å®šä¿å­˜
      async function saveSmsConfig(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        console.log("ğŸ” é–‹å§‹ä¿å­˜SMSè¨­å®š...");
        console.log("ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:", window.currentUser);

        if (!window.currentUser) {
          document.getElementById("smsStatus").innerHTML =
            '<span style="color: #d32f2f;">âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</span>';
          return;
        }

        try {
          document.getElementById("smsStatus").innerHTML =
            '<span style="color: #1976d2;">ğŸ’¾ è¨­å®šã‚’ä¿å­˜ä¸­...</span>';

          const result = await window.FirebaseAPI.updateSmsConfig(
            formData.get("smsApiUrl"),
            formData.get("smsApiId"),
            formData.get("smsApiPassword"),
            formData.get("smsTextA"),
            formData.get("smsTextB")
          );

          console.log("ğŸ“Š ä¿å­˜çµæœ:", result);

          if (result.success) {
            document.getElementById("smsStatus").innerHTML =
              '<span style="color: #388e3c;">âœ… SMSè¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼ˆ5é …ç›®å®Œäº†ï¼‰</span>';
          } else {
            document.getElementById("smsStatus").innerHTML =
              '<span style="color: #d32f2f;">âŒ ã‚¨ãƒ©ãƒ¼: ' +
              result.error +
              "</span>";
            console.error("ä¿å­˜å¤±æ•—è©³ç´°:", result);
          }
        } catch (error) {
          console.error("ğŸ’¥ ä¿å­˜ç•°å¸¸:", error);
          document.getElementById("smsStatus").innerHTML =
            '<span style="color: #d32f2f;">âŒ ã‚¨ãƒ©ãƒ¼: ' +
            error.message +
            "</span>";
        }
      }

      // åˆå§‹åŒ–RPAçŠ¶æ€æ˜¾ç¤º
      function initializeRpaStatus() {
        // è®¾ç½®æ‰€æœ‰é…ç½®é¡¹ä¸ºåŠ è½½çŠ¶æ€
        updateConfigStatus("emailStatus", "loading", "èª­ã¿è¾¼ã¿ä¸­...");
        updateConfigStatus("smsApiStatus", "loading", "èª­ã¿è¾¼ã¿ä¸­...");
        updateConfigStatus("apiIdStatus", "loading", "èª­ã¿è¾¼ã¿ä¸­...");
        updateConfigStatus("apiPasswordStatus", "loading", "èª­ã¿è¾¼ã¿ä¸­...");
        updateConfigStatus("templateAStatus", "loading", "èª­ã¿è¾¼ã¿ä¸­...");
        updateConfigStatus("templateBStatus", "loading", "èª­ã¿è¾¼ã¿ä¸­...");
      }

      // RPAè¨­å®šèª­ã¿è¾¼ã¿
      async function loadRpaConfig() {
        try {
          const result = await window.FirebaseAPI.getRpaConfig();

          if (result.success) {
            const config = result.config;

            // æ›´æ–°å„é¡¹é…ç½®çŠ¶æ€
            updateConfigStatus(
              "emailStatus",
              config.email,
              config.email || "æœªè¨­å®š"
            );
            updateConfigStatus(
              "smsApiStatus",
              config.smsApiUrl,
              config.smsApiUrl ? `SMS-CONSOLE (${config.smsApiUrl})` : "æœªè¨­å®š"
            );
            updateConfigStatus(
              "apiIdStatus",
              config.smsApiId,
              config.smsApiId ? "è¨­å®šæ¸ˆã¿" : "æœªè¨­å®š"
            );
            updateConfigStatus(
              "apiPasswordStatus",
              config.smsApiPassword,
              config.smsApiPassword ? "è¨­å®šæ¸ˆã¿" : "æœªè¨­å®š"
            );
            updateConfigStatus(
              "templateAStatus",
              config.smsTextA,
              config.smsTextA ? "è¨­å®šæ¸ˆã¿" : "æœªè¨­å®š"
            );
            updateConfigStatus(
              "templateBStatus",
              config.smsTextB,
              config.smsTextB ? "è¨­å®šæ¸ˆã¿" : "æœªè¨­å®š"
            );
          } else {
            // å¦‚æœè·å–é…ç½®å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            updateConfigStatus("emailStatus", false, "ã‚¨ãƒ©ãƒ¼");
            updateConfigStatus("smsApiStatus", false, "ã‚¨ãƒ©ãƒ¼");
            updateConfigStatus("apiIdStatus", false, "ã‚¨ãƒ©ãƒ¼");
            updateConfigStatus("apiPasswordStatus", false, "ã‚¨ãƒ©ãƒ¼");
            updateConfigStatus("templateAStatus", false, "ã‚¨ãƒ©ãƒ¼");
            updateConfigStatus("templateBStatus", false, "ã‚¨ãƒ©ãƒ¼");
          }
        } catch (error) {
          console.error("è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
          // é”™è¯¯æ—¶æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
          updateConfigStatus("emailStatus", false, "ã‚¨ãƒ©ãƒ¼");
          updateConfigStatus("smsApiStatus", false, "ã‚¨ãƒ©ãƒ¼");
          updateConfigStatus("apiIdStatus", false, "ã‚¨ãƒ©ãƒ¼");
          updateConfigStatus("apiPasswordStatus", false, "ã‚¨ãƒ©ãƒ¼");
          updateConfigStatus("templateAStatus", false, "ã‚¨ãƒ©ãƒ¼");
          updateConfigStatus("templateBStatus", false, "ã‚¨ãƒ©ãƒ¼");
        }
      }

      // æ›´æ–°é…ç½®çŠ¶æ€æ˜¾ç¤º
      function updateConfigStatus(elementId, isConfigured, displayText) {
        const statusElement = document.getElementById(elementId);
        const statusIcon =
          statusElement.parentElement.querySelector(".status-icon");

        if (statusElement) {
          statusElement.textContent = displayText;
        }

        if (statusIcon) {
          // æ¸…é™¤æ‰€æœ‰çŠ¶æ€ç±»
          statusIcon.className = "status-icon";

          if (isConfigured === "loading") {
            // åŠ è½½çŠ¶æ€
            statusIcon.classList.add("status-pending");
            statusIcon.textContent = "â³";
          } else if (isConfigured) {
            // é…ç½®æ­£ç¡®çŠ¶æ€
            statusIcon.classList.add("status-ok");
            statusIcon.textContent = "âœ…";
          } else {
            // é…ç½®é”™è¯¯æˆ–æœªè®¾ç½®çŠ¶æ€
            statusIcon.classList.add("status-error");
            statusIcon.textContent = "âŒ";
          }
        }
      }

      // RPAå®Ÿè¡ŒçŠ¶æ…‹ç®¡ç†
      let rpaStatus = {
        isRunning: false,
        processId: null,
        startTime: null,
        logs: [],
      };

      // RPAå®Ÿè¡Œ
      async function executeRpa() {
        try {
          const resultDiv = document.getElementById("rpaResult");
          resultDiv.style.display = "block";
          resultDiv.innerHTML = "<p>ğŸ”„ RPAè¨­å®šã‚’ç¢ºèªä¸­...</p>";
          resultDiv.className = "result-display";

          // è¨­å®šç¢ºèª
          const configResult = await window.FirebaseAPI.getRpaConfig();

          if (!configResult.success) {
            throw new Error(configResult.error);
          }

          const config = configResult.config;

          // è¨­å®šå®Œäº†ãƒã‚§ãƒƒã‚¯ (RPAå®Ÿè¡Œã«å¿…è¦ãªå…¨é …ç›®)
          const isConfigComplete =
            config.email &&
            config.emailPassword &&
            config.sitePassword &&
            config.smsApiUrl &&
            config.smsApiId &&
            config.smsApiPassword &&
            config.smsTextA &&
            config.smsTextB;

          if (!isConfigComplete) {
            resultDiv.innerHTML = `
              <h3>âš ï¸ è¨­å®šä¸å®Œå…¨</h3>
              <p>RPAå®Ÿè¡Œå‰ã«ä»¥ä¸‹ã®è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„:</p>
              <ul style="margin: 12px 0; padding-left: 20px;">
                  ${!config.email ? "<li>ğŸ“§ Gmail/Indeedã‚¢ãƒ‰ãƒ¬ã‚¹</li>" : ""}
                  ${
                    !config.emailPassword
                      ? "<li>ğŸ”‘ Gmailã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</li>"
                      : ""
                  }
                  ${
                    !config.sitePassword
                      ? "<li>ğŸŒ Indeedãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</li>"
                      : ""
                  }
                  ${!config.smsApiUrl ? "<li>ğŸŒ SMS API URL</li>" : ""}
                  ${!config.smsApiId ? "<li>ğŸ”‘ SMS API ID</li>" : ""}
                  ${
                    !config.smsApiPassword
                      ? "<li>ğŸ” SMS API ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</li>"
                      : ""
                  }
                  ${!config.smsTextA ? "<li>ï¿½ SMSãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆA</li>" : ""}
                  ${!config.smsTextB ? "<li>ğŸ“ SMSãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆB</li>" : ""}
              </ul>
            `;
            resultDiv.className = "result-display error";
            return;
          }

          // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼UIDå–å¾—
          if (!window.currentUser) {
            throw new Error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“");
          }

          const userUid = window.currentUser.uid;

          // RPAå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã®é¸æŠ
          const mode = await showRpaModeDialog();
          if (!mode) {
            resultDiv.innerHTML = "<p>RPAå®Ÿè¡ŒãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚</p>";
            return;
          }

          resultDiv.innerHTML = "<p>ğŸš€ RPA ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</p>";

          // RPAå®Ÿè¡ŒAPIå‘¼ã³å‡ºã—
          const response = await fetch(`${API_BASE_URL}/api/rpa/start`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userUid: userUid,
              mode: mode.mode,
              interval: mode.interval || 5,
            }),
          });

          const result = await response.json();

          if (result.success) {
            rpaStatus.isRunning = true;
            rpaStatus.processId = userUid;
            rpaStatus.startTime = new Date();

            resultDiv.innerHTML = `
              <h3>ğŸš€ RPAå®Ÿè¡Œé–‹å§‹</h3>
              <p>âœ… RPA ãƒ—ãƒ­ã‚»ã‚¹ãŒæ­£å¸¸ã«é–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚</p>
              <div style="margin: 16px 0;">
                <strong>å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰:</strong> ${
                  mode.mode === "1" ? "å˜ç™ºå®Ÿè¡Œ" : "é€£ç¶šç›£è¦–"
                }${mode.mode === "2" ? ` (${mode.interval}ç§’é–“éš”)` : ""}
              </div>
              <div style="margin: 16px 0;">
                <button onclick="stopRpa()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                  ğŸ›‘ RPAåœæ­¢
                </button>
                <button onclick="refreshRpaStatus()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 8px;">
                  ï¿½ çŠ¶æ…‹æ›´æ–°
                </button>
                <button onclick="showRpaLogs()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 8px;">
                  ğŸ“‹ ãƒ­ã‚°è¡¨ç¤º
                </button>
              </div>
              <div id="rpaStatusInfo" style="margin-top: 16px; padding: 12px; background: #e8f5e8; border-radius: 4px; font-size: 0.9em;">
                <div>é–‹å§‹æ™‚é–“: ${new Date().toLocaleString()}</div>
                <div>ãƒ—ãƒ­ã‚»ã‚¹ID: ${userUid.slice(0, 8)}...</div>
              </div>
            `;
            resultDiv.className = "result-display success";

            // å®šæœŸçš„ã«çŠ¶æ…‹ã‚’æ›´æ–°
            startStatusPolling();
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error("RPA execution error:", error);
          document.getElementById("rpaResult").innerHTML = `
            <h3>âŒ RPAå®Ÿè¡Œã‚¨ãƒ©ãƒ¼</h3>
            <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
            <div style="margin-top: 12px; font-size: 0.9em; color: #666;">
              RPA ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>
              ã‚³ãƒãƒ³ãƒ‰: <code>npm start</code> ã¾ãŸã¯ <code>node rpa_server.js</code>
            </div>
          `;
          document.getElementById("rpaResult").className =
            "result-display error";
        }
      }

      // RPAå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      function showRpaModeDialog() {
        return new Promise((resolve) => {
          const dialog = document.createElement("div");
          dialog.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); display: flex; align-items: center; 
            justify-content: center; z-index: 10000;
          `;

          dialog.innerHTML = `
            <div style="background: white; padding: 24px; border-radius: 8px; max-width: 400px; width: 90%;">
              <h3 style="margin: 0 0 16px 0; color: #6f8333;">ï¿½ RPAå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰é¸æŠ</h3>
              <div style="margin: 16px 0;">
                <label style="display: block; margin: 8px 0; cursor: pointer;">
                  <input type="radio" name="rpaMode" value="1" checked style="margin-right: 8px;">
                  <strong>å˜ç™ºå®Ÿè¡Œ</strong> - ç¾åœ¨ã®æœªèª­ãƒ¡ãƒ¼ãƒ«ã‚’1å›ã ã‘å‡¦ç†
                </label>
                <label style="display: block; margin: 8px 0; cursor: pointer;">
                  <input type="radio" name="rpaMode" value="2" style="margin-right: 8px;">
                  <strong>é€£ç¶šç›£è¦–</strong> - æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚’ç¶™ç¶šçš„ã«ç›£è¦–ãƒ»å‡¦ç†
                </label>
              </div>
              <div id="intervalSetting" style="margin: 16px 0; display: none;">
                <label>ç›£è¦–é–“éš”ï¼ˆç§’ï¼‰: 
                  <input type="number" id="intervalInput" value="5" min="1" max="3600" 
                         style="width: 60px; margin-left: 8px;">
                </label>
              </div>
              <div style="margin-top: 20px; text-align: right;">
                <button onclick="this.closest('div').parentElement.remove(); resolve(null);" 
                        style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 8px;">
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="
                  const mode = document.querySelector('input[name=rpaMode]:checked').value;
                  const interval = document.getElementById('intervalInput').value;
                  this.closest('div').parentElement.remove();
                  resolve({mode, interval: parseInt(interval)});
                " style="background: #6f8333; color: white; border: none; padding: 8px 16px; border-radius: 4px;">
                  å®Ÿè¡Œé–‹å§‹
                </button>
              </div>
            </div>
          `;

          // é€£ç¶šç›£è¦–é¸æŠæ™‚ã«é–“éš”è¨­å®šã‚’è¡¨ç¤º
          dialog.querySelectorAll('input[name="rpaMode"]').forEach((radio) => {
            radio.addEventListener("change", () => {
              const intervalSetting = dialog.querySelector("#intervalSetting");
              intervalSetting.style.display =
                radio.value === "2" ? "block" : "none";
            });
          });

          document.body.appendChild(dialog);
        });
      }

      // RPAåœæ­¢
      async function stopRpa() {
        try {
          if (!rpaStatus.isRunning || !window.currentUser) {
            return;
          }

          const response = await fetch(`${API_BASE_URL}/api/rpa/stop`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userUid: window.currentUser.uid,
            }),
          });

          const result = await response.json();

          if (result.success) {
            rpaStatus.isRunning = false;
            rpaStatus.processId = null;

            const resultDiv = document.getElementById("rpaResult");
            resultDiv.innerHTML = `
              <h3>ğŸ›‘ RPAåœæ­¢å®Œäº†</h3>
              <p>âœ… RPA ãƒ—ãƒ­ã‚»ã‚¹ãŒæ­£å¸¸ã«åœæ­¢ã•ã‚Œã¾ã—ãŸã€‚</p>
              <p>å®Ÿè¡Œæ™‚é–“: ${
                rpaStatus.startTime
                  ? Math.round((new Date() - rpaStatus.startTime) / 1000)
                  : 0
              }ç§’</p>
            `;
            resultDiv.className = "result-display";

            // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
            stopStatusPolling();
          }
        } catch (error) {
          console.error("RPA stop error:", error);
        }
      }

      // RPAçŠ¶æ…‹æ›´æ–°
      async function refreshRpaStatus() {
        try {
          if (!window.currentUser) return;

          const response = await fetch(
            `${API_BASE_URL}/api/rpa/status/${window.currentUser.uid}`
          );
          const result = await response.json();

          if (result.success) {
            const statusInfo = document.getElementById("rpaStatusInfo");
            if (statusInfo) {
              statusInfo.innerHTML = `
                <div>çŠ¶æ…‹: ${getStatusText(result.status)}</div>
                <div>é–‹å§‹æ™‚é–“: ${new Date(
                  result.startTime
                ).toLocaleString()}</div>
                ${
                  result.endTime
                    ? `<div>çµ‚äº†æ™‚é–“: ${new Date(
                        result.endTime
                      ).toLocaleString()}</div>`
                    : ""
                }
                <div>ãƒ­ã‚°ä»¶æ•°: ${result.logCount || 0}ä»¶</div>
                ${
                  result.error
                    ? `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${result.error}</div>`
                    : ""
                }
              `;
            }

            // ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã—ã¦ã„ã‚‹å ´åˆ
            if (result.status === "completed" || result.status === "error") {
              rpaStatus.isRunning = false;
              stopStatusPolling();
            }
          }
        } catch (error) {
          console.error("Status refresh error:", error);
        }
      }

      // RPA ãƒ­ã‚°è¡¨ç¤º
      async function showRpaLogs() {
        try {
          if (!window.currentUser) return;

          const response = await fetch(
            `${API_BASE_URL}/api/rpa/logs/${window.currentUser.uid}?limit=100`
          );
          const result = await response.json();

          if (result.success) {
            const logWindow = window.open(
              "",
              "rpaLogs",
              "width=800,height=600,scrollbars=yes"
            );
            logWindow.document.write(`
              <html>
                <head><title>RPA ãƒ­ã‚° - ${window.currentUser.uid}</title></head>
                <body style="font-family: monospace; padding: 16px; background: #f5f5f5;">
                  <h2>ğŸ” RPA å®Ÿè¡Œãƒ­ã‚°</h2>
                  <div style="margin: 8px 0;">ç·ãƒ­ã‚°æ•°: ${
                    result.totalLogs
                  }ä»¶</div>
                  <hr>
                  ${result.logs
                    .map(
                      (log) => `
                    <div style="margin: 4px 0; padding: 8px; background: ${
                      log.type === "stderr" ? "#ffe6e6" : "white"
                    }; border-left: 3px solid ${
                        log.type === "stderr" ? "#dc3545" : "#28a745"
                      };">
                      <div style="font-size: 0.8em; color: #666;">${new Date(
                        log.timestamp
                      ).toLocaleString()} [${log.type.toUpperCase()}]</div>
                      <pre style="margin: 4px 0; white-space: pre-wrap;">${
                        log.message
                      }</pre>
                    </div>
                  `
                    )
                    .join("")}
                </body>
              </html>
            `);
          }
        } catch (error) {
          console.error("Log display error:", error);
          alert("ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      // çŠ¶æ…‹ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›
      function getStatusText(status) {
        const statusMap = {
          running: "ğŸŸ¢ å®Ÿè¡Œä¸­",
          completed: "âœ… å®Œäº†",
          error: "âŒ ã‚¨ãƒ©ãƒ¼",
          stopped: "ğŸ›‘ åœæ­¢",
          not_running: "âš« åœæ­¢ä¸­",
        };
        return statusMap[status] || status;
      }

      // çŠ¶æ…‹ãƒãƒ¼ãƒªãƒ³ã‚°ç®¡ç†
      let statusPollingInterval = null;

      function startStatusPolling() {
        if (statusPollingInterval) return;

        statusPollingInterval = setInterval(() => {
          if (rpaStatus.isRunning) {
            refreshRpaStatus();
          } else {
            stopStatusPolling();
          }
        }, 5000); // 5ç§’é–“éš”
      }

      function stopStatusPolling() {
        if (statusPollingInterval) {
          clearInterval(statusPollingInterval);
          statusPollingInterval = null;
        }
      }

      console.log("âœ… Main App Firebase initialized");

      // ===== SMSå€‹åˆ¥é€ä¿¡æ©Ÿèƒ½ =====

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      function toggleTemplate() {
        const checkbox = document.getElementById("useTemplate");
        const selector = document.getElementById("templateSelector");
        if (checkbox.checked) {
          selector.style.display = "block";
        } else {
          selector.style.display = "none";
        }
      }

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
      async function loadTemplate(type) {
        try {
          const config = await window.FirebaseAPI.getUserConfig();
          const textarea = document.getElementById("smsContent");

          if (type === "A" && config.sms_config?.sms_text_a) {
            textarea.value = config.sms_config.sms_text_a;
          } else if (type === "B" && config.sms_config?.sms_text_b) {
            textarea.value = config.sms_config.sms_text_b;
          } else {
            alert(
              `ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ${type}ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚SMSè¨­å®šã§å…ˆã«è¨­å®šã—ã¦ãã ã•ã„ã€‚`
            );
          }
        } catch (error) {
          console.error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
          alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      // SMSå€‹åˆ¥é€ä¿¡
      // ===== æœåŠ¡å™¨è¿æ¥çŠ¶æ€æ£€æŸ¥ =====
      async function checkServerConnection() {
        const statusDiv = document.getElementById("connectionStatus");
        const statusText = document.getElementById("statusText");

        try {
          const response = await fetch(`${API_BASE_URL}/api/health`, {
            method: "GET",
            timeout: 3000,
          });

          if (response.ok) {
            statusDiv.style.backgroundColor = "#e8f5e8";
            statusDiv.style.color = "#2e7d2e";
            statusText.textContent = "âœ… RPAæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (localhost:8888)";
          } else {
            throw new Error("Server response not OK");
          }
        } catch (error) {
          statusDiv.style.backgroundColor = "#ffe6e6";
          statusDiv.style.color = "#d32f2f";
          statusText.innerHTML =
            "âŒ RPAæœåŠ¡å™¨æœªè¿æ¥ - <strong>è¯·è¿è¡Œ: å¯åŠ¨RPAç½‘ç«™.bat</strong>";
        }
      }

      // ===== SMSé€ä¿¡åŠŸèƒ½ =====
      async function sendIndividualSms(event) {
        event.preventDefault();

        const phone = document.getElementById("recipientPhone").value.trim();
        const message = document.getElementById("smsContent").value.trim();
        const resultDiv = document.getElementById("smsResult");

        console.log("ğŸ” SMSé€ä¿¡é–‹å§‹:", {
          phone,
          messageLength: message.length,
        });

        if (!window.currentUser) {
          resultDiv.innerHTML =
            '<span style="color: #d32f2f;">âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</span>';
          return;
        }

        try {
          resultDiv.innerHTML =
            '<span style="color: #1976d2;">ğŸ“¤ SMSé€ä¿¡ä¸­...</span>';

          // SMSé€ä¿¡APIå‘¼ã³å‡ºã—
          const response = await fetch(`${API_BASE_URL}/api/sms/send`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userUid: window.currentUser.uid,
              phone: phone,
              message: message,
            }),
          });

          const result = await response.json();
          console.log("ğŸ“Š SMSé€ä¿¡çµæœ:", result);

          if (result.success) {
            resultDiv.innerHTML =
              '<span style="color: #388e3c;">âœ… SMSé€ä¿¡æˆåŠŸï¼</span>';

            // é€ä¿¡å±¥æ­´ã«è¿½åŠ  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰æƒ…å ±ã‚’å«ã‚€
            const statusInfo = result.output
              ? result.output.match(/STATUS: (\d+)/)?.[1] || "200"
              : "200";
            addToSmsHistory(
              phone,
              message,
              "success",
              `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusInfo}`
            );

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById("recipientPhone").value = "";
            document.getElementById("smsContent").value = "";
            document.getElementById("useTemplate").checked = false;
            toggleTemplate();
          } else {
            resultDiv.innerHTML =
              '<span style="color: #d32f2f;">âŒ SMSé€ä¿¡å¤±æ•—: ' +
              result.error +
              "</span>";

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰æƒ…å ±ã‚’æŠ½å‡º
            const statusInfo = result.details
              ? result.details.match(/STATUS: (\d+)/)?.[1] || "Unknown"
              : "Unknown";
            addToSmsHistory(
              phone,
              message,
              "failed",
              `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusInfo} - ${result.error}`
            );
          }
        } catch (error) {
          console.error("ğŸ’¥ SMSé€ä¿¡ç•°å¸¸:", error);
          resultDiv.innerHTML =
            '<span style="color: #d32f2f;">âŒ ã‚¨ãƒ©ãƒ¼: ' +
            error.message +
            "</span>";
          addToSmsHistory(
            phone,
            message,
            "error",
            `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`
          );
        }
      }

      // é€ä¿¡å±¥æ­´ç®¡ç†
      let smsHistory = JSON.parse(localStorage.getItem("smsHistory") || "[]");

      function addToSmsHistory(phone, message, status, statusInfo = null) {
        const historyItem = {
          timestamp: new Date().toLocaleString("ja-JP"),
          phone: phone,
          message:
            message.substring(0, 50) + (message.length > 50 ? "..." : ""),
          status: status,
          statusInfo: statusInfo, // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰æƒ…å ±ã‚’è¿½åŠ 
        };

        smsHistory.unshift(historyItem); // æœ€æ–°ã‚’ä¸Šã«
        if (smsHistory.length > 100) {
          // æœ€å¤§100ä»¶ä¿æŒ
          smsHistory = smsHistory.slice(0, 100);
        }

        localStorage.setItem("smsHistory", JSON.stringify(smsHistory));
        updateSmsHistoryDisplay();
      }

      function updateSmsHistoryDisplay() {
        const historyDiv = document.getElementById("smsHistory");
        if (!historyDiv) return;

        if (smsHistory.length === 0) {
          historyDiv.innerHTML =
            '<p style="color: #666; text-align: center; margin: 20px 0; font-style: italic;">é€ä¿¡å±¥æ­´ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>';
          return;
        }

        const historyHtml = smsHistory
          .map((item, index) => {
            const statusIcon =
              {
                success: "âœ…",
                failed: "âŒ",
                error: "ğŸ’¥",
              }[item.status] || "â“";

            const statusColor =
              {
                success: "#388e3c",
                failed: "#d32f2f",
                error: "#ff9800",
              }[item.status] || "#666";

            const statusBgColor =
              {
                success: "#e8f5e8",
                failed: "#ffeaea",
                error: "#fff3e0",
              }[item.status] || "#f5f5f5";

            return `
            <div style="
              border: 1px solid #e0e0e0; 
              border-radius: 8px; 
              padding: 12px; 
              margin-bottom: 12px;
              background: linear-gradient(135deg, #ffffff 0%, ${statusBgColor} 100%);
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              transition: box-shadow 0.2s ease;
            " onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div style="flex: 1;">
                  <div style="font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 4px;">
                    ğŸ“± ${item.phone}
                  </div>
                  <div style="color: #666; font-size: 0.95em; line-height: 1.4; margin-bottom: 6px;">
                    ${item.message}
                  </div>
                </div>
                <div style="
                  display: flex; 
                  align-items: center; 
                  background: white;
                  padding: 4px 8px;
                  border-radius: 12px;
                  border: 1px solid ${statusColor};
                  color: ${statusColor};
                  font-weight: bold;
                  font-size: 0.85em;
                ">
                  ${statusIcon} ${item.status.toUpperCase()}
                </div>
              </div>
              <div style="
                display: flex; 
                justify-content: space-between; 
                align-items: center;
                padding-top: 8px;
                border-top: 1px solid #f0f0f0;
                font-size: 0.8em;
                color: #888;
              ">
                <span>ğŸ•’ ${item.timestamp}</span>
                ${
                  item.statusInfo
                    ? '<span style="color: ' +
                      (item.status === "success" ? "#388e3c" : "#d32f2f") +
                      '; font-weight: 500;">' +
                      item.statusInfo +
                      "</span>"
                    : ""
                }
                ${
                  item.error && !item.statusInfo
                    ? '<span style="color: #d32f2f; font-weight: 500;">ã‚¨ãƒ©ãƒ¼: ' +
                      item.error +
                      "</span>"
                    : ""
                }
              </div>
            </div>
          `;
          })
          .join("");

        historyDiv.innerHTML = historyHtml;
      }

      function clearSmsHistory() {
        if (confirm("é€ä¿¡å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          smsHistory = [];
          localStorage.removeItem("smsHistory");
          updateSmsHistoryDisplay();
        }
      }

      // å±¥æ­´é …ç›®ã‚’ç·¨é›†ã™ã‚‹é–¢æ•°
      function editHistoryItem(index) {
        const item = smsHistory[index];
        if (!item) return;

        const newPhone = prompt("é›»è©±ç•ªå·ã‚’ç·¨é›†:", item.phone);
        if (newPhone === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆ

        const newMessage = prompt("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†:", item.message);
        if (newMessage === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆ

        const newStatus = prompt(
          "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç·¨é›† (success/failed/error):",
          item.status
        );
        if (newStatus === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆ

        // æ›´æ–°
        smsHistory[index] = {
          ...item,
          phone: newPhone,
          message: newMessage,
          status: newStatus,
          timestamp: item.timestamp + " (ç·¨é›†æ¸ˆã¿)",
        };

        localStorage.setItem("smsHistory", JSON.stringify(smsHistory));
        updateSmsHistoryDisplay();
      }

      // å±¥æ­´é …ç›®ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
      function deleteHistoryItem(index) {
        const item = smsHistory[index];
        if (!item) return;

        if (
          confirm(
            `ã“ã®å±¥æ­´é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né›»è©±ç•ªå·: ${
              item.phone
            }\nãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${item.message.substring(0, 50)}...`
          )
        ) {
          smsHistory.splice(index, 1);
          localStorage.setItem("smsHistory", JSON.stringify(smsHistory));
          updateSmsHistoryDisplay();
        }
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å±¥æ­´ã‚’è¡¨ç¤º
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(() => {
          updateSmsHistoryDisplay();
          checkServerConnection(); // ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        }, 1000);

        // å®šæœŸçš„ã«æ¥ç¶šçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ30ç§’ã”ã¨ï¼‰
        setInterval(checkServerConnection, 30000);
      });

      // ãƒ‡ãƒãƒƒã‚°é–¢æ•°ï¼šç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      window.checkUserStatus = function () {
        console.log("=== ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ ===");
        console.log("ğŸ” window.currentUser:", window.currentUser);
        console.log("ğŸ” auth.currentUser:", auth.currentUser);
        console.log(
          "ğŸ” UserEmailè¡¨ç¤º:",
          document.getElementById("userEmail")?.textContent
        );
        if (window.currentUser) {
          console.log("ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°:", {
            email: window.currentUser.email,
            uid: window.currentUser.uid,
            emailVerified: window.currentUser.emailVerified,
          });
        }
        console.log("==================");
      };

      // é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
      setTimeout(() => {
        window.checkUserStatus();
      }, 2000);
    </script>
  </body>
</html>
