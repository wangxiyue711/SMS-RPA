<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SMS Publisher - å€‹äººSMSé€ä¿¡ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="styles/main_app.css" />
    <!-- Firebase v9 ç¨³å®šç‰ˆæœ¬ -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      // Firebase é…ç½®
      const firebaseConfig = {
        apiKey: "AIzaSyCYPji9NAg4T3z8JJERd_MniCbdteC9P2g",
        authDomain: "rpa-sms-reclab.firebaseapp.com",
        projectId: "rpa-sms-reclab",
        storageBucket: "rpa-sms-reclab.firebasestorage.app",
        messagingSenderId: "815415607045",
        appId: "1:815415607045:web:e432022c62fbcb6899c16c",
        measurementId: "G-53WG49PVJF",
      };

      // Firebase åˆå§‹åŒ–
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // å…¨å±€å¯ç”¨
      window.auth = auth;
      window.db = db;

      // Firebase API å‡½æ•°
      window.FirebaseAPI = {
        async logoutUser() {
          try {
            await signOut(auth);
            return { success: true };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },

        // è·å–ç”¨æˆ·é…ç½®
        async getUserConfig() {
          if (!window.currentUser) {
            throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
          }

          try {
            const userConfigDoc = await getDoc(
              doc(db, "user_configs", window.currentUser.uid)
            );
            if (userConfigDoc.exists()) {
              return userConfigDoc.data();
            } else {
              // åˆ›å»ºé»˜è®¤é…ç½®
              const defaultConfig = {
                user_id: window.currentUser.uid,
                email: window.currentUser.email,
                sms_config: {
                  provider: "",
                  api_url: "",
                  api_id: "",
                  api_password: "",
                },
                created_at: new Date(),
                updated_at: new Date(),
              };

              await setDoc(
                doc(db, "user_configs", window.currentUser.uid),
                defaultConfig
              );
              return defaultConfig;
            }
          } catch (error) {
            throw new Error("è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
          }
        },

        // æ›´æ–°SMSé…ç½®
        async updateSmsConfig(smsConfig) {
          if (!window.currentUser) {
            throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
          }

          try {
            await updateDoc(doc(db, "user_configs", window.currentUser.uid), {
              sms_config: smsConfig,
              updated_at: new Date(),
            });
            return { success: true };
          } catch (error) {
            throw new Error("SMSè¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
          }
        },
      };

      // è®¤è¯çŠ¶æ€ç›‘å¬
      onAuthStateChanged(auth, (user) => {
        if (user) {
          window.currentUser = user;
          showMainApp();
        } else {
          window.currentUser = null;
          showLoginPage();
        }
      });

      function showLoginPage() {
        window.location.href = "login.html";
      }

      function showMainApp() {
        document.getElementById("userEmail").textContent =
          window.currentUser.email;
        loadUserConfig();
      }

      // åŠ è½½ç”¨æˆ·é…ç½®
      async function loadUserConfig() {
        try {
          const config = await window.FirebaseAPI.getUserConfig();
          if (config && config.sms_config) {
            document.getElementById("apiUrl").value =
              config.sms_config.api_url || "";
            document.getElementById("apiId").value =
              config.sms_config.api_id || "";
            document.getElementById("apiPassword").value =
              config.sms_config.api_password || "";
          }
        } catch (error) {
          console.error("è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
          alert("è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      }

      // ä¿å­˜SMSé…ç½®
      window.saveSmsConfig = async function () {
        try {
          const smsConfig = {
            api_url: document.getElementById("apiUrl").value,
            api_id: document.getElementById("apiId").value,
            api_password: document.getElementById("apiPassword").value,
          };

          await window.FirebaseAPI.updateSmsConfig(smsConfig);
          alert("SMSè¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
        } catch (error) {
          console.error("è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
          alert("è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      };

      // å‘é€SMS
      window.sendSMS = async function () {
        const phone = document.getElementById("phoneNumber").value;
        const message = document.getElementById("smsMessage").value;

        if (!phone || !message) {
          alert("é›»è©±ç•ªå·ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        if (!window.currentUser) {
          alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
          return;
        }

        try {
          document.getElementById("sendButton").disabled = true;
          document.getElementById("sendButton").textContent = "é€ä¿¡ä¸­...";

          const response = await fetch("/api/sms/send", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userUid: window.currentUser.uid,
              phone: phone,
              message: message,
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert("SMSé€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
            document.getElementById("phoneNumber").value = "";
            document.getElementById("smsMessage").value = "";
          } else {
            alert("SMSé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + result.error);
          }
        } catch (error) {
          console.error("SMSé€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
          alert("SMSé€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
        } finally {
          document.getElementById("sendButton").disabled = false;
          document.getElementById("sendButton").textContent = "SMSé€ä¿¡";
        }
      };

      // ç™»å‡º
      window.logout = async function () {
        try {
          await window.FirebaseAPI.logoutUser();
          window.location.href = "login.html";
        } catch (error) {
          console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", error);
          alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      };
    </script>
  </head>
  <body>
    <div class="container">
      <!-- å¤´éƒ¨ -->
      <header class="header">
        <div class="header-content">
          <h1 class="logo">
            <span class="logo-icon">ğŸ“±</span>
            SMS Publisher
          </h1>
          <div class="user-info">
            <span class="user-email" id="userEmail">user@example.com</span>
            <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          </div>
        </div>
      </header>

      <!-- ä¸»è¦å†…å®¹ -->
      <main class="main-content">
        <!-- SMSé…ç½®éƒ¨åˆ† -->
        <section class="config-section">
          <div class="card">
            <div class="card-header">
              <h2>SMS API è¨­å®š</h2>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label for="apiUrl">API URL:</label>
                <input
                  type="text"
                  id="apiUrl"
                  placeholder="SMS API URL ã‚’å…¥åŠ›"
                />
              </div>
              <div class="form-group">
                <label for="apiId">API ID:</label>
                <input type="text" id="apiId" placeholder="API ID ã‚’å…¥åŠ›" />
              </div>
              <div class="form-group">
                <label for="apiPassword">API Password:</label>
                <input
                  type="password"
                  id="apiPassword"
                  placeholder="API ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                />
              </div>
              <button class="save-btn" onclick="saveSmsConfig()">
                è¨­å®šã‚’ä¿å­˜
              </button>
            </div>
          </div>
        </section>

        <!-- SMSå‘é€éƒ¨åˆ† -->
        <section class="sms-section">
          <div class="card">
            <div class="card-header">
              <h2>å€‹äººSMSé€ä¿¡</h2>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label for="phoneNumber">é›»è©±ç•ªå·:</label>
                <input
                  type="tel"
                  id="phoneNumber"
                  placeholder="é›»è©±ç•ªå·ã‚’å…¥åŠ› (ä¾‹: 09012345678)"
                />
              </div>
              <div class="form-group">
                <label for="smsMessage">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</label>
                <textarea
                  id="smsMessage"
                  rows="4"
                  placeholder="é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"
                ></textarea>
              </div>
              <button class="send-btn" id="sendButton" onclick="sendSMS()">
                SMSé€ä¿¡
              </button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </body>
</html>
